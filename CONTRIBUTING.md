# Contributing

ありがとうございます！このリポジトリへの貢献方法についてまとめます。

## 事前チェック（必須）
- 開発前に最新の `main` ブランチを pull してください。
- 変更は feature ブランチを切って作業し、PR を作成してください。

## テストと実行確認（必須）
- プッシュ前に必ず以下を実行して下さい。

```bash
# ワークスペースルートを PYTHONPATH に追加してテストを実行
PYTHONPATH=. pytest
# 実行確認
python app.py
```

## コミットメッセージ
- 変更内容が分かる短いメッセージを使用してください。例: `Fix: handle None in foo`。

## Pull Request
- PR には変更の要約と動作確認手順（テストコマンド含む）を必ず記載してください。

---
小さな変更でもテストが通ることを確認してから PR を投げてください。

## DDD (Domain-Driven Design) への段階的移行について

このリポジトリは段階的に DDD 構成へ移行しています。現在のトップレベル構成の目安:

- `src/domain/` — ドメインモデルとドメインサービス（ビジネスロジック）
- `src/application/` — ユースケース（アプリケーション層のオーケストレーション、ハンドラ）
- `src/infrastructure/` — 外部 API へのアダプター（LINE API 等）
- 既存のモジュールは互換性を壊さないために shim を置いています。

移行の基本ルール:

1. 小さいコミットで進める（1つの責務だけ移動する）。
2. 既存の外部インターフェース（関数名・引数）を変えないようにする。変更する場合は shim を用意して互換性を保つ。
3. 移動後は必ずテストを実行して動作を確認する。
4. 外部 API 呼び出しは直接ドメインに書かない。ドメインはポート（インターフェース）を定義し、インフラ側でアダプタを実装する。

具体的な次の作業（推奨順）:

1. `src/domain/` にドメインロジックを移動し、結果を shim でラップする（完了済みの作業あり）。
2. `src/application/handlers.py` を作り、Flask のルーティングとイベントハンドラを移す。
3. `src/infrastructure/` に外部 API のアダプターを実装して、テスト用のモックを差し替えられるようにする。
4. CI を更新してレイヤー別のユニットテストを回す。

何か作業を始めるときは Issue を作って作業計画を共有してください。

## shim（互換ラッパ）を削除する際の注意

このリポジトリでは以前トップレベルに shim（`src/*.py` で domain/ 以下の実装を再エクスポートするファイル）を置いて互換性を保っていました。shim を削除する際は次の点を必ず守ってください。

1. tracked（git によって追跡されている）ファイルを削除する場合は必ず `git rm` を使ってください。
	- 例: `git rm src/some_shim.py && git commit -m "Remove shim"`
	- ファイルを単に削除してコミットを作成しないと、index に古いファイルが残ることがあります。
2. 削除後にローカルで次のコマンドで確認してください。

```bash
# 変更がステージングされていない場合は git status で確認
git status --porcelain
# git にまだ残っている tracked ファイルを確認
git ls-files 'src/*' | grep some_shim || true
```

3. テストは必ず `PYTHONPATH=. pytest` で動作確認してください（CI と同じ環境で実行するため）。

4. 破壊的な API 変更となるため PR の説明に明記し、マージ前にチームに周知してください。

5. 推奨: shim の削除は単独の PR にして、CI が通ることを確認してからマージしてください。

もしよければ、この注意をチェックする CI スクリプト（`scripts/check-no-shims.sh`）や pre-commit フックを追加して自動化します。

